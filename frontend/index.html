<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Use Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Left Panel - Session Management -->
            <div class="col-3 bg-light p-3">
                <h5>Task History</h5>
                <div id="sessions" class="mb-3"></div>
                <button id="newSession" class="btn btn-primary w-100">Start New Agent Task</button>
            </div>
            
            <!-- Middle Panel - VNC Connection -->
            <div class="col-6 p-0">
                <iframe id="vnc" src="http://localhost:6080/vnc.html?autoconnect=1&resize=scale" 
                        class="w-100 h-100 border-0"></iframe>
            </div>
            
            <!-- Right Panel - Chat -->
            <div class="col-3 d-flex flex-column p-3">
                <h5>Chat Session</h5>
                <div id="messages" class="flex-grow-1 overflow-auto border p-3 mb-3" style="height: 400px;"></div>
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Enter your task...">
                    <button id="sendBtn" class="btn btn-success">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSession = null;
        let ws = null;

        // Create new session
        document.getElementById('newSession').onclick = async () => {
            const res = await fetch('/api/v1/sessions', { method: 'POST' });
            const data = await res.json();
            currentSession = data.session_id;
            connectWebSocket();
            loadSessions();
            document.getElementById('messages').innerHTML = '';
        };

        // Connect WebSocket
        function connectWebSocket() {
            if (ws) ws.close();
            ws = new WebSocket(`ws://localhost:8000/api/v1/sessions/${currentSession}/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addMessage(data.type, data.content || data.result || data.message);
            };
        }

        // Send message
        document.getElementById('sendBtn').onclick = async () => {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !currentSession) return;
            
            addMessage('user', message);
            input.value = '';
            
            await fetch(`/api/v1/sessions/${currentSession}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: message })
            });
        };

        // Add message to chat
        function addMessage(type, content) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `mb-2 p-2 rounded ${type === 'user' ? 'bg-primary text-white' : 'bg-secondary text-white'}`;
            div.textContent = content;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // Load sessions
        async function loadSessions() {
            const res = await fetch('/api/v1/sessions');
            const data = await res.json();
            const sessionsDiv = document.getElementById('sessions');
            sessionsDiv.innerHTML = data.sessions.map(s => 
                `<div class="p-2 border rounded mb-1 cursor-pointer" onclick="selectSession('${s.id}')">${s.id.slice(0,8)}...</div>`
            ).join('');
        }

        // Select session
        function selectSession(sessionId) {
            currentSession = sessionId;
            connectWebSocket();
            // Load session messages here if needed
        }

        // Enter key support
        document.getElementById('messageInput').onkeypress = (e) => {
            if (e.key === 'Enter') document.getElementById('sendBtn').click();
        };

        // Initialize
        loadSessions();
    </script>
</body>
</html>